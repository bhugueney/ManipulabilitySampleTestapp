#include "Simulation.h"
#include "WorldParser/WorldParser.h"
#include "WorldParser/WorldParserObj.h"

#include <time.h>

using namespace manip_core;

Simulation* Simulation::instance = 0;

Simulation::Simulation()
	: manager_()
	, simpParams_()
	, pRobot(0)
	, timerHandler_()
	, postureManager_(manager_.GetPostureManager())
	, motionHandler_(manager_)
	, drawManager_(manager_)
{
	srand((unsigned int)(time(0))); //Init Random generation
	// TODO
}

Simulation::~Simulation()
{
	// TODO
	delete postureManager_;
}

namespace simspace
{
	void start()
	{
		Simulation* sim = Simulation::GetInstance();
		sim->simpParams_.GetCamera()->Update();
	}

	void simLoop(int pause)
	{
		Simulation* sim = Simulation::GetInstance();
		sim->Update();
		sim->Draw();
	}
}

void Simulation::Start(int argc, char *argv[])
{
	srand((unsigned int)(time(0))); //Init Random generation
	//init robot
	
	WorldParser parser;
	std::string filename;
	
	if(argc > 1)
	{
		filename = std::string(argv[1]);
	}
	else
	{
		filename = std::string("../world/worldTest.xml");
	}
	
	
	parser.CreateWorld(filename);
	//simpParams_.buildWorld();
	if(argc > 2)
	{
		WorldParserObj objParse;
		objParse.CreateWorld(std::string(argv[2]));
	}

	if(simpParams_.angleValues_.size() > 0)
	{
		pRobot = manager_.CreateRobot(simpParams_.robotType_, simpParams_.robotBasis_, simpParams_.angleValues_);
	}
	else
	{
		pRobot = manager_.CreateRobot(simpParams_.robotType_, simpParams_.robotBasis_);
	}
	dRobot = new DrawRobot(pRobot);
	postureManager_->SetJumpToTarget(simpParams_.jumpToTarget_);
	postureManager_->InitSamples(pRobot,simpParams_.nbSamples_);

    simpParams_.fn_.version = DS_VERSION;
    simpParams_.fn_.start   = &simspace::start;
    simpParams_.fn_.step    = &simspace::simLoop;
	simpParams_.fn_.command = simpParams_.command;
    simpParams_.fn_.stop    = 0;

	timerHandler_.Register(&motionHandler_);
	timerHandler_.Start();
    dsSimulationLoop (argc,argv,1280,720, &simpParams_.fn_);
}

void Simulation::Update()
{
	timerHandler_.Update();
	timerHandler_.GetTimer().Stop();
	simpParams_.GetCamera()->Update();
	if(simpParams_.inputHandler_)
	{
		simpParams_.inputHandler_->Update();
	}
	timerHandler_.GetTimer().Start();
}

void Simulation::Draw()
{
	drawManager_.Draw();
	dRobot->Draw();
}

void Simulation::Reset()
{
	delete dRobot;
	delete pRobot;
	pRobot = manager_.CreateRobot(simpParams_.robotType_, simpParams_.robotBasis_, simpParams_.angleValues_);
	dRobot = new DrawRobot(pRobot);
	simpParams_.GetCamera()->Reset();
	motionHandler_.Reset();
}
